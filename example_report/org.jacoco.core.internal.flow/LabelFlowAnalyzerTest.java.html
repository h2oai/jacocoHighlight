<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/highlight_report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LabelFlowAnalyzerTest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco</a> &gt; <a href="index.source.html" class="el_package">org.jacoco.core.internal.flow</a> &gt; <span class="el_source">LabelFlowAnalyzerTest.java</span></div><h1>LabelFlowAnalyzerTest.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2009, 2016 Mountainminds GmbH &amp; Co. KG and Contributors
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Marc R. Hoffmann - initial API and implementation
 *    
 *******************************************************************************/
package org.jacoco.core.internal.flow;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertSame;
import static org.junit.Assert.assertTrue;
import static org.objectweb.asm.Opcodes.*;

import org.junit.Before;
import org.junit.Test;
import org.objectweb.asm.Label;
import org.objectweb.asm.Opcodes;

/**
 * Unit tests for {@link LabelFlowAnalyzer}.
 */
<span class="fc" id="L28">public class LabelFlowAnalyzerTest {</span>

	private LabelFlowAnalyzer analyzer;

	private Label label;

	@Before
	public void setup() {
<span class="fc" id="L36">		analyzer = new LabelFlowAnalyzer();</span>
<span class="fc" id="L37">		label = new Label();</span>
<span class="fc" id="L38">	}</span>

	@Test
	public void testInit() {
<span class="fc" id="L42">		assertFalse(analyzer.successor);</span>
<span class="fc" id="L43">		assertTrue(analyzer.first);</span>
<span class="fc" id="L44">		assertNull(analyzer.lineStart);</span>
<span class="fc" id="L45">	}</span>

	@Test
	public void testFlowScenario01() {
<span class="fc" id="L49">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L50">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L51">	}</span>

	@Test
	public void testFlowScenario02() {
<span class="fc" id="L55">		analyzer.visitJumpInsn(GOTO, label);</span>
<span class="fc" id="L56">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L57">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L58">	}</span>

	@Test
	public void testFlowScenario03() {
<span class="fc" id="L62">		analyzer.visitInsn(RETURN);</span>
<span class="fc" id="L63">		analyzer.visitLabel(label);</span>
<span class="fc" id="L64">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L65">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L66">	}</span>

	@Test
	public void testFlowScenario04() {
<span class="fc" id="L70">		analyzer.visitLabel(label);</span>
<span class="fc" id="L71">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L72">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L73">	}</span>

	@Test
	public void testFlowScenario05() {
<span class="fc" id="L77">		analyzer.visitLabel(label);</span>
<span class="fc" id="L78">		analyzer.visitJumpInsn(GOTO, label);</span>
<span class="fc" id="L79">		assertTrue(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L80">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L81">	}</span>

	@Test
	public void testFlowScenario06() {
<span class="fc" id="L85">		analyzer.visitJumpInsn(IFEQ, label);</span>
<span class="fc" id="L86">		analyzer.visitLabel(label);</span>
<span class="fc" id="L87">		assertTrue(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L88">		assertTrue(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L89">	}</span>

	@Test
	public void testFlowScenario07() {
<span class="fc" id="L93">		analyzer.visitJumpInsn(IFEQ, label);</span>
<span class="fc" id="L94">		analyzer.visitJumpInsn(GOTO, label);</span>
<span class="fc" id="L95">		assertTrue(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L96">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L97">	}</span>

	@Test
	public void testFlowScenario08() {
<span class="fc" id="L101">		analyzer.visitJumpInsn(IFEQ, label);</span>
<span class="fc" id="L102">		analyzer.visitJumpInsn(IFGT, label);</span>
<span class="fc" id="L103">		analyzer.visitLabel(label);</span>
<span class="fc" id="L104">		assertTrue(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L105">		assertTrue(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L106">	}</span>

	@Test
	public void testFlowScenario09() {
<span class="fc" id="L110">		analyzer.visitInsn(Opcodes.NOP);</span>
<span class="fc" id="L111">		analyzer.visitLabel(label);</span>
<span class="fc" id="L112">		analyzer.visitLabel(label);</span>
<span class="fc" id="L113">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L114">		assertTrue(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L115">	}</span>

	@Test
	public void testFlowScenario10() {
<span class="fc" id="L119">		analyzer.visitTryCatchBlock(new Label(), new Label(), label,</span>
				&quot;java/lang/Exception&quot;);
<span class="fc" id="L121">		analyzer.visitJumpInsn(GOTO, label);</span>
<span class="fc" id="L122">		assertTrue(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L123">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L124">	}</span>

	@Test
	public void testFlowScenario11() {
		// Even if the same label is referenced multiple times but from the same
		// source instruction this is only counted as one target.
<span class="fc" id="L130">		analyzer.visitLookupSwitchInsn(label, new int[] { 0, 1 }, new Label[] {</span>
				label, label });
<span class="fc" id="L132">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L133">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L134">	}</span>

	@Test
	public void testFlowScenario12() {
		// Even if the same label is referenced multiple times but from the same
		// source instruction this is only counted as one target.
<span class="fc" id="L140">		analyzer.visitTableSwitchInsn(0, 1, label, new Label[] { label, label });</span>
<span class="fc" id="L141">		assertFalse(LabelInfo.isMultiTarget(label));</span>
<span class="fc" id="L142">		assertFalse(LabelInfo.isSuccessor(label));</span>
<span class="fc" id="L143">	}</span>

	@Test
	public void testInsn() {
<span class="fc" id="L147">		testInsn(NOP, true);</span>
<span class="fc" id="L148">		testInsn(ACONST_NULL, true);</span>
<span class="fc" id="L149">		testInsn(ICONST_M1, true);</span>
<span class="fc" id="L150">		testInsn(ICONST_0, true);</span>
<span class="fc" id="L151">		testInsn(ICONST_1, true);</span>
<span class="fc" id="L152">		testInsn(ICONST_2, true);</span>
<span class="fc" id="L153">		testInsn(ICONST_3, true);</span>
<span class="fc" id="L154">		testInsn(ICONST_4, true);</span>
<span class="fc" id="L155">		testInsn(ICONST_5, true);</span>
<span class="fc" id="L156">		testInsn(LCONST_0, true);</span>
<span class="fc" id="L157">		testInsn(LCONST_1, true);</span>
<span class="fc" id="L158">		testInsn(FCONST_0, true);</span>
<span class="fc" id="L159">		testInsn(FCONST_1, true);</span>
<span class="fc" id="L160">		testInsn(FCONST_2, true);</span>
<span class="fc" id="L161">		testInsn(DCONST_0, true);</span>
<span class="fc" id="L162">		testInsn(DCONST_1, true);</span>
<span class="fc" id="L163">		testInsn(IALOAD, true);</span>
<span class="fc" id="L164">		testInsn(LALOAD, true);</span>
<span class="fc" id="L165">		testInsn(FALOAD, true);</span>
<span class="fc" id="L166">		testInsn(DALOAD, true);</span>
<span class="fc" id="L167">		testInsn(AALOAD, true);</span>
<span class="fc" id="L168">		testInsn(BALOAD, true);</span>
<span class="fc" id="L169">		testInsn(CALOAD, true);</span>
<span class="fc" id="L170">		testInsn(SALOAD, true);</span>
<span class="fc" id="L171">		testInsn(IASTORE, true);</span>
<span class="fc" id="L172">		testInsn(LASTORE, true);</span>
<span class="fc" id="L173">		testInsn(FASTORE, true);</span>
<span class="fc" id="L174">		testInsn(DASTORE, true);</span>
<span class="fc" id="L175">		testInsn(AASTORE, true);</span>
<span class="fc" id="L176">		testInsn(BASTORE, true);</span>
<span class="fc" id="L177">		testInsn(CASTORE, true);</span>
<span class="fc" id="L178">		testInsn(SASTORE, true);</span>
<span class="fc" id="L179">		testInsn(POP, true);</span>
<span class="fc" id="L180">		testInsn(POP2, true);</span>
<span class="fc" id="L181">		testInsn(DUP, true);</span>
<span class="fc" id="L182">		testInsn(DUP_X1, true);</span>
<span class="fc" id="L183">		testInsn(DUP_X2, true);</span>
<span class="fc" id="L184">		testInsn(DUP2, true);</span>
<span class="fc" id="L185">		testInsn(DUP2_X1, true);</span>
<span class="fc" id="L186">		testInsn(DUP2_X2, true);</span>
<span class="fc" id="L187">		testInsn(SWAP, true);</span>
<span class="fc" id="L188">		testInsn(IADD, true);</span>
<span class="fc" id="L189">		testInsn(LADD, true);</span>
<span class="fc" id="L190">		testInsn(FADD, true);</span>
<span class="fc" id="L191">		testInsn(DADD, true);</span>
<span class="fc" id="L192">		testInsn(ISUB, true);</span>
<span class="fc" id="L193">		testInsn(LSUB, true);</span>
<span class="fc" id="L194">		testInsn(FSUB, true);</span>
<span class="fc" id="L195">		testInsn(DSUB, true);</span>
<span class="fc" id="L196">		testInsn(IMUL, true);</span>
<span class="fc" id="L197">		testInsn(LMUL, true);</span>
<span class="fc" id="L198">		testInsn(FMUL, true);</span>
<span class="fc" id="L199">		testInsn(DMUL, true);</span>
<span class="fc" id="L200">		testInsn(IDIV, true);</span>
<span class="fc" id="L201">		testInsn(LDIV, true);</span>
<span class="fc" id="L202">		testInsn(FDIV, true);</span>
<span class="fc" id="L203">		testInsn(DDIV, true);</span>
<span class="fc" id="L204">		testInsn(IREM, true);</span>
<span class="fc" id="L205">		testInsn(LREM, true);</span>
<span class="fc" id="L206">		testInsn(FREM, true);</span>
<span class="fc" id="L207">		testInsn(DREM, true);</span>
<span class="fc" id="L208">		testInsn(INEG, true);</span>
<span class="fc" id="L209">		testInsn(LNEG, true);</span>
<span class="fc" id="L210">		testInsn(FNEG, true);</span>
<span class="fc" id="L211">		testInsn(DNEG, true);</span>
<span class="fc" id="L212">		testInsn(ISHL, true);</span>
<span class="fc" id="L213">		testInsn(LSHL, true);</span>
<span class="fc" id="L214">		testInsn(ISHR, true);</span>
<span class="fc" id="L215">		testInsn(LSHR, true);</span>
<span class="fc" id="L216">		testInsn(IUSHR, true);</span>
<span class="fc" id="L217">		testInsn(LUSHR, true);</span>
<span class="fc" id="L218">		testInsn(IAND, true);</span>
<span class="fc" id="L219">		testInsn(LAND, true);</span>
<span class="fc" id="L220">		testInsn(IOR, true);</span>
<span class="fc" id="L221">		testInsn(LOR, true);</span>
<span class="fc" id="L222">		testInsn(IXOR, true);</span>
<span class="fc" id="L223">		testInsn(LXOR, true);</span>
<span class="fc" id="L224">		testInsn(I2L, true);</span>
<span class="fc" id="L225">		testInsn(I2F, true);</span>
<span class="fc" id="L226">		testInsn(I2D, true);</span>
<span class="fc" id="L227">		testInsn(L2I, true);</span>
<span class="fc" id="L228">		testInsn(L2F, true);</span>
<span class="fc" id="L229">		testInsn(L2D, true);</span>
<span class="fc" id="L230">		testInsn(F2I, true);</span>
<span class="fc" id="L231">		testInsn(F2L, true);</span>
<span class="fc" id="L232">		testInsn(F2D, true);</span>
<span class="fc" id="L233">		testInsn(D2I, true);</span>
<span class="fc" id="L234">		testInsn(D2L, true);</span>
<span class="fc" id="L235">		testInsn(D2F, true);</span>
<span class="fc" id="L236">		testInsn(I2B, true);</span>
<span class="fc" id="L237">		testInsn(I2C, true);</span>
<span class="fc" id="L238">		testInsn(I2S, true);</span>
<span class="fc" id="L239">		testInsn(LCMP, true);</span>
<span class="fc" id="L240">		testInsn(FCMPL, true);</span>
<span class="fc" id="L241">		testInsn(FCMPG, true);</span>
<span class="fc" id="L242">		testInsn(DCMPL, true);</span>
<span class="fc" id="L243">		testInsn(DCMPG, true);</span>
<span class="fc" id="L244">		testInsn(IRETURN, false);</span>
<span class="fc" id="L245">		testInsn(LRETURN, false);</span>
<span class="fc" id="L246">		testInsn(FRETURN, false);</span>
<span class="fc" id="L247">		testInsn(DRETURN, false);</span>
<span class="fc" id="L248">		testInsn(ARETURN, false);</span>
<span class="fc" id="L249">		testInsn(RETURN, false);</span>
<span class="fc" id="L250">		testInsn(ARRAYLENGTH, true);</span>
<span class="fc" id="L251">		testInsn(ATHROW, false);</span>
<span class="fc" id="L252">		testInsn(MONITORENTER, true);</span>
<span class="fc" id="L253">		testInsn(MONITOREXIT, true);</span>
<span class="fc" id="L254">	}</span>

	private void testInsn(int opcode, boolean expected) {
		// ensure the flags are actually set:
<span class="fc bfc" id="L258" title="All 2 branches covered.">		analyzer.successor = !expected;</span>
<span class="fc" id="L259">		analyzer.first = true;</span>
<span class="fc" id="L260">		analyzer.visitInsn(opcode);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">		assertTrue(expected == analyzer.successor);</span>
<span class="fc" id="L262">		assertFalse(analyzer.first);</span>
<span class="fc" id="L263">	}</span>

	@Test(expected = AssertionError.class)
	public void testVisitInsnNegative() {
<span class="nc" id="L267">		analyzer.visitInsn(RET);</span>
<span class="nc" id="L268">	}</span>

	@Test
	public void testIntInsn() {
<span class="fc" id="L272">		analyzer.visitIntInsn(BIPUSH, 0);</span>
<span class="fc" id="L273">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L274">		assertFalse(analyzer.first);</span>
<span class="fc" id="L275">	}</span>

	@Test
	public void testVarInsn() {
<span class="fc" id="L279">		analyzer.visitVarInsn(ILOAD, 0);</span>
<span class="fc" id="L280">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L281">		assertFalse(analyzer.first);</span>
<span class="fc" id="L282">	}</span>

	@Test
	public void testTypeInsn() {
<span class="fc" id="L286">		analyzer.visitTypeInsn(NEW, &quot;java/lang/String&quot;);</span>
<span class="fc" id="L287">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L288">		assertFalse(analyzer.first);</span>
<span class="fc" id="L289">	}</span>

	@Test
	public void testFieldInsn() {
<span class="fc" id="L293">		analyzer.successor = false;</span>
<span class="fc" id="L294">		analyzer.visitFieldInsn(GETFIELD, &quot;Foo&quot;, &quot;name&quot;, &quot;Ljava/lang/String;&quot;);</span>
<span class="fc" id="L295">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L296">		assertFalse(analyzer.first);</span>
<span class="fc" id="L297">	}</span>

	@Test
	public void testLineNumber() {
<span class="fc" id="L301">		analyzer.visitLineNumber(42, label);</span>
<span class="fc" id="L302">		assertSame(label, analyzer.lineStart);</span>
<span class="fc" id="L303">	}</span>

	@Test
	public void testMethodInsn() {
<span class="fc" id="L307">		analyzer.visitLineNumber(42, label);</span>
<span class="fc" id="L308">		analyzer.visitMethodInsn(INVOKEVIRTUAL, &quot;Foo&quot;, &quot;doit&quot;, &quot;()V&quot;, false);</span>
<span class="fc" id="L309">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L310">		assertFalse(analyzer.first);</span>
<span class="fc" id="L311">		assertTrue(LabelInfo.isMethodInvocationLine(label));</span>
<span class="fc" id="L312">	}</span>

	@Test
	public void testInvokeDynamicInsn() {
<span class="fc" id="L316">		analyzer.visitLineNumber(42, label);</span>
<span class="fc" id="L317">		analyzer.visitInvokeDynamicInsn(&quot;foo&quot;, &quot;()V&quot;, null);</span>
<span class="fc" id="L318">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L319">		assertFalse(analyzer.first);</span>
<span class="fc" id="L320">		assertTrue(LabelInfo.isMethodInvocationLine(label));</span>
<span class="fc" id="L321">	}</span>

	@Test
	public void testJumpInsn() {
<span class="fc" id="L325">		testJumpInsn(IFEQ, true);</span>
<span class="fc" id="L326">		testJumpInsn(IFNE, true);</span>
<span class="fc" id="L327">		testJumpInsn(IFLT, true);</span>
<span class="fc" id="L328">		testJumpInsn(IFGE, true);</span>
<span class="fc" id="L329">		testJumpInsn(IFGT, true);</span>
<span class="fc" id="L330">		testJumpInsn(IFLE, true);</span>
<span class="fc" id="L331">		testJumpInsn(IF_ICMPEQ, true);</span>
<span class="fc" id="L332">		testJumpInsn(IF_ICMPNE, true);</span>
<span class="fc" id="L333">		testJumpInsn(IF_ICMPLT, true);</span>
<span class="fc" id="L334">		testJumpInsn(IF_ICMPGE, true);</span>
<span class="fc" id="L335">		testJumpInsn(IF_ICMPGT, true);</span>
<span class="fc" id="L336">		testJumpInsn(IF_ICMPLE, true);</span>
<span class="fc" id="L337">		testJumpInsn(IF_ACMPEQ, true);</span>
<span class="fc" id="L338">		testJumpInsn(IF_ACMPNE, true);</span>
<span class="fc" id="L339">		testJumpInsn(GOTO, false);</span>
<span class="fc" id="L340">		testJumpInsn(IFNULL, true);</span>
<span class="fc" id="L341">		testJumpInsn(IFNONNULL, true);</span>
<span class="fc" id="L342">	}</span>

	private void testJumpInsn(int opcode, boolean expected) {
		// ensure the flags are actually set:
<span class="fc bfc" id="L346" title="All 2 branches covered.">		analyzer.successor = !expected;</span>
<span class="fc" id="L347">		analyzer.first = true;</span>
<span class="fc" id="L348">		analyzer.visitJumpInsn(opcode, label);</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">		assertTrue(expected == analyzer.successor);</span>
<span class="fc" id="L350">		assertFalse(analyzer.first);</span>
<span class="fc" id="L351">	}</span>

	@Test(expected = AssertionError.class)
	public void testVisitJumpInsnNegative() {
<span class="nc" id="L355">		analyzer.visitJumpInsn(JSR, label);</span>
<span class="nc" id="L356">	}</span>

	@Test
	public void testLdcInsn() {
<span class="fc" id="L360">		analyzer.visitLdcInsn(&quot;Foo&quot;);</span>
<span class="fc" id="L361">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L362">		assertFalse(analyzer.first);</span>
<span class="fc" id="L363">	}</span>

	@Test
	public void testIincInsn() {
<span class="fc" id="L367">		analyzer.visitIincInsn(0, 1);</span>
<span class="fc" id="L368">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L369">		assertFalse(analyzer.first);</span>
<span class="fc" id="L370">	}</span>

	@Test
	public void testTableSwitchInsn() {
<span class="fc" id="L374">		analyzer.visitTableSwitchInsn(0, 0, label, new Label[] { label });</span>
<span class="fc" id="L375">		assertFalse(analyzer.successor);</span>
<span class="fc" id="L376">		assertFalse(analyzer.first);</span>
<span class="fc" id="L377">	}</span>

	@Test
	public void testLookupSwitchInsn() {
<span class="fc" id="L381">		analyzer.visitLookupSwitchInsn(label, new int[] { 0 },</span>
				new Label[] { label });
<span class="fc" id="L383">		assertFalse(analyzer.successor);</span>
<span class="fc" id="L384">		assertFalse(analyzer.first);</span>
<span class="fc" id="L385">	}</span>

	@Test
	public void testMultiANewArrayInsn() {
<span class="fc" id="L389">		analyzer.visitMultiANewArrayInsn(&quot;java/lang/String&quot;, 3);</span>
<span class="fc" id="L390">		assertTrue(analyzer.successor);</span>
<span class="fc" id="L391">		assertFalse(analyzer.first);</span>
<span class="fc" id="L392">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>