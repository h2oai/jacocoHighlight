<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/highlight_report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CoverageTransformerTest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco</a> &gt; <a href="index.source.html" class="el_package">org.jacoco.agent.rt.internal</a> &gt; <span class="el_source">CoverageTransformerTest.java</span></div><h1>CoverageTransformerTest.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2009, 2016 Mountainminds GmbH &amp; Co. KG and Contributors
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Marc R. Hoffmann - initial API and implementation
 *    
 *******************************************************************************/
package org.jacoco.agent.rt.internal;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.instrument.IllegalClassFormatException;
import java.security.CodeSource;
import java.security.ProtectionDomain;
import java.security.cert.Certificate;

import org.jacoco.core.JaCoCo;
import org.jacoco.core.runtime.AbstractRuntime;
import org.jacoco.core.runtime.AgentOptions;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.objectweb.asm.MethodVisitor;

/**
 * Unit tests for {@link CoverageTransformer}.
 */
<span class="fc" id="L39">public class CoverageTransformerTest {</span>

	private ExceptionRecorder recorder;

	private AgentOptions options;

	private ClassLoader classLoader;

	private ProtectionDomain protectionDomain;

	private StubRuntime runtime;

	@Before
	public void setup() {
<span class="fc" id="L53">		recorder = new ExceptionRecorder();</span>
<span class="fc" id="L54">		options = new AgentOptions();</span>
<span class="fc" id="L55">		classLoader = getClass().getClassLoader();</span>
<span class="fc" id="L56">		protectionDomain = getClass().getProtectionDomain();</span>
<span class="fc" id="L57">		runtime = new StubRuntime();</span>
<span class="fc" id="L58">	}</span>

	@After
	public void teardown() {
<span class="fc" id="L62">		recorder.assertNoException();</span>
<span class="fc" id="L63">	}</span>

	@Test
	public void testFilterAgentClass() {
<span class="fc" id="L67">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L68">		assertFalse(t.filter(classLoader,</span>
				&quot;org/jacoco/agent/rt/internal/somepkg/SomeClass&quot;,
				protectionDomain));
<span class="fc" id="L71">	}</span>

	@Test
	public void testFilterInclBootstrapClassesPositive() {
<span class="fc" id="L75">		options.setInclBootstrapClasses(true);</span>
<span class="fc" id="L76">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L77">		assertTrue(t.filter(null, &quot;java/util/TreeSet&quot;, protectionDomain));</span>
<span class="fc" id="L78">	}</span>

	@Test
	public void testFilterInclBootstrapClassesNegative() {
<span class="fc" id="L82">		options.setInclBootstrapClasses(false);</span>
<span class="fc" id="L83">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L84">		assertFalse(t.filter(null, &quot;java/util/TreeSet&quot;, protectionDomain));</span>
<span class="fc" id="L85">	}</span>

	@Test
	public void testFilterClassLoaderPositive1() {
<span class="fc" id="L89">		options.setInclBootstrapClasses(false);</span>
<span class="fc" id="L90">		options.setExclClassloader(&quot;org.jacoco.agent.SomeWhere$*&quot;);</span>
<span class="fc" id="L91">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L92">		assertTrue(t.filter(classLoader, &quot;org/example/Foo&quot;, protectionDomain));</span>
<span class="fc" id="L93">	}</span>

	@Test
	public void testFilterClassLoaderPositive2() {
<span class="fc" id="L97">		options.setInclBootstrapClasses(true);</span>
<span class="fc" id="L98">		options.setExclClassloader(&quot;org.jacoco.agent.SomeWhere$*&quot;);</span>
<span class="fc" id="L99">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L100">		assertTrue(t.filter(classLoader, &quot;org/example/Foo&quot;, protectionDomain));</span>
<span class="fc" id="L101">	}</span>

	@Test
	public void testFilterClassLoaderNegative1() {
<span class="fc" id="L105">		options.setInclBootstrapClasses(false);</span>
<span class="fc" id="L106">		options.setExclClassloader(&quot;org.jacoco.agent.rt.internal.CoverageTransformerTest$*&quot;);</span>
<span class="fc" id="L107">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L108">		ClassLoader myClassLoader = new ClassLoader(null) {</span>
		};
<span class="fc" id="L110">		assertFalse(t</span>
				.filter(myClassLoader, &quot;org/example/Foo&quot;, protectionDomain));
<span class="fc" id="L112">	}</span>

	@Test
	public void testFilterClassLoaderNegative2() {
<span class="fc" id="L116">		options.setInclBootstrapClasses(true);</span>
<span class="fc" id="L117">		options.setExclClassloader(&quot;org.jacoco.agent.rt.internal.CoverageTransformerTest$*&quot;);</span>
<span class="fc" id="L118">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L119">		ClassLoader myClassLoader = new ClassLoader(null) {</span>
		};
<span class="fc" id="L121">		assertFalse(t</span>
				.filter(myClassLoader, &quot;org/example/Foo&quot;, protectionDomain));
<span class="fc" id="L123">	}</span>

	@Test
	public void testFilterIncludedClassPositive() {
<span class="fc" id="L127">		options.setIncludes(&quot;org.jacoco.core.*:org.jacoco.agent.rt.*&quot;);</span>
<span class="fc" id="L128">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L129">		assertTrue(t.filter(classLoader, &quot;org/jacoco/core/Foo&quot;,</span>
				protectionDomain));
<span class="fc" id="L131">	}</span>

	@Test
	public void testFilterIncludedClassNegative() {
<span class="fc" id="L135">		options.setIncludes(&quot;org.jacoco.core.*:org.jacoco.agent.rt.*&quot;);</span>
<span class="fc" id="L136">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L137">		assertFalse(t.filter(classLoader, &quot;org/jacoco/report/Foo&quot;,</span>
				protectionDomain));
<span class="fc" id="L139">	}</span>

	@Test
	public void testFilterExcludedClassPositive() {
<span class="fc" id="L143">		options.setExcludes(&quot;*Test&quot;);</span>
<span class="fc" id="L144">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L145">		assertFalse(t.filter(classLoader, &quot;org/jacoco/core/FooTest&quot;,</span>
				protectionDomain));
<span class="fc" id="L147">	}</span>

	@Test
	public void testFilterExcludedClassPositiveInner() {
<span class="fc" id="L151">		options.setExcludes(&quot;org.jacoco.example.Foo$Inner&quot;);</span>
<span class="fc" id="L152">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L153">		assertFalse(t.filter(classLoader, &quot;org/jacoco/example/Foo$Inner&quot;,</span>
				protectionDomain));
<span class="fc" id="L155">	}</span>

	@Test
	public void testFilterExcludedClassNegative() {
<span class="fc" id="L159">		options.setExcludes(&quot;*Test&quot;);</span>
<span class="fc" id="L160">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L161">		assertTrue(t.filter(classLoader, &quot;org/jacoco/core/Foo&quot;,</span>
				protectionDomain));
<span class="fc" id="L163">	}</span>

	@Test
	public void testFilterSourceLocationPositive1() {
<span class="fc" id="L167">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L168">		assertFalse(t.filter(classLoader, &quot;org/jacoco/core/Foo&quot;, null));</span>
<span class="fc" id="L169">	}</span>

	@Test
	public void testFilterSourceLocationPositive2() {
<span class="fc" id="L173">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L174">		ProtectionDomain pd = new ProtectionDomain(null, null);</span>
<span class="fc" id="L175">		assertFalse(t.filter(classLoader, &quot;org/jacoco/core/Foo&quot;, pd));</span>
<span class="fc" id="L176">	}</span>

	@Test
	public void testFilterSourceLocationPositive3() {
<span class="fc" id="L180">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L181">		CodeSource cs = new CodeSource(null, new Certificate[0]);</span>
<span class="fc" id="L182">		ProtectionDomain pd = new ProtectionDomain(cs, null);</span>
<span class="fc" id="L183">		assertFalse(t.filter(classLoader, &quot;org/jacoco/core/Foo&quot;, pd));</span>
<span class="fc" id="L184">	}</span>

	@Test
	public void testFilterSourceLocationNegative() {
<span class="fc" id="L188">		options.setInclNoLocationClasses(true);</span>
<span class="fc" id="L189">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L190">		assertTrue(t.filter(classLoader, &quot;org/jacoco/core/Foo&quot;, null));</span>
<span class="fc" id="L191">	}</span>

	@Test
	public void testTransformFiltered1() throws IllegalClassFormatException {
<span class="fc" id="L195">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L196">		assertNull(t.transform(classLoader, &quot;org.jacoco.Sample&quot;, null, null,</span>
				new byte[0]));
<span class="fc" id="L198">	}</span>

	@Test
	public void testTransformFiltered2() throws IllegalClassFormatException {
<span class="fc" id="L202">		CoverageTransformer t = createTransformer();</span>
<span class="fc" id="L203">		assertNull(t.transform(null, &quot;org.jacoco.Sample&quot;, null,</span>
				protectionDomain, new byte[0]));
<span class="fc" id="L205">	}</span>

	@Test
	public void testTransformFailure() {
<span class="fc" id="L209">		CoverageTransformer t = createTransformer();</span>
		try {
<span class="nc" id="L211">			t.transform(classLoader, &quot;org.jacoco.Sample&quot;, null,</span>
					protectionDomain, null);
<span class="nc" id="L213">			fail(&quot;IllegalClassFormatException expected.&quot;);</span>
<span class="fc" id="L214">		} catch (IllegalClassFormatException e) {</span>
<span class="fc" id="L215">			assertEquals(&quot;Error while instrumenting class org.jacoco.Sample.&quot;,</span>
					e.getMessage());
<span class="nc" id="L217">		}</span>
<span class="fc" id="L218">		recorder.assertException(IllegalClassFormatException.class,</span>
				&quot;Error while instrumenting class org.jacoco.Sample.&quot;,
				IOException.class);
<span class="fc" id="L221">		recorder.clear();</span>
<span class="fc" id="L222">	}</span>

	@Test
	public void testRedefinedClass() throws Exception {
<span class="fc" id="L226">		CoverageTransformer t = createTransformer();</span>
		// Just pick any non-system class outside our namespace
<span class="fc" id="L228">		final Class&lt;?&gt; target = JaCoCo.class;</span>
<span class="fc" id="L229">		assertNull(t.transform(classLoader, target.getName(), target,</span>
				protectionDomain, getClassData(target)));
<span class="fc" id="L231">	}</span>

	private CoverageTransformer createTransformer() {
<span class="fc" id="L234">		return new CoverageTransformer(runtime, options, recorder);</span>
	}

	private static byte[] getClassData(Class&lt;?&gt; clazz) throws IOException {
<span class="fc" id="L238">		final String resource = &quot;/&quot; + clazz.getName().replace('.', '/')</span>
				+ &quot;.class&quot;;
<span class="fc" id="L240">		final InputStream in = clazz.getResourceAsStream(resource);</span>
<span class="fc" id="L241">		final ByteArrayOutputStream out = new ByteArrayOutputStream();</span>
<span class="fc" id="L242">		byte[] buffer = new byte[0x100];</span>
		int len;
<span class="fc bfc" id="L244" title="All 2 branches covered.">		while ((len = in.read(buffer)) != -1) {</span>
<span class="fc" id="L245">			out.write(buffer, 0, len);</span>
		}
<span class="fc" id="L247">		in.close();</span>
<span class="fc" id="L248">		return out.toByteArray();</span>
	}

<span class="fc" id="L251">	private static class StubRuntime extends AbstractRuntime {</span>

<span class="fc" id="L253">		public StubRuntime() {</span>
<span class="fc" id="L254">		}</span>

		public int generateDataAccessor(long classid, String classname,
				int probecount, MethodVisitor mv) {
<span class="nc" id="L258">			return 0;</span>
		}

		public void shutdown() {
<span class="nc" id="L262">		}</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>